/*============================================================================*/
/*      Copyright (C) 2009-2013 Texas Instruments Incorporated.               */
/*                      All Rights Reserved                                   */
/*============================================================================*/

/* ===========================================================================*/
/*   @file : vcop_bilateralFilter_tb.c                                        */

/*   @brief  : Driver file for testing bilateral filter                       */
/*            This testbench then compares the result with the expected result*/

/*   @author Gajanan Ambi(gajanan.ambi@ti.com)                                */

/*   @version 0.0 (March 2013) : Base version.                                */
/*============================================================================*/

#include <stdio.h>
#include <stdlib.h>

/*----------------------------------------------------------------------------*/
/*PIX_FMT: input data format                                                  */
/*4: RGBA format                                                              */
/*1: Planar format                                                            */
/*----------------------------------------------------------------------------*/
#define PIX_FMT 4 

/*----------------------------------------------------------------------------*/
/*WINDOW_SIZE: Filter window size                                             */ 
/*----------------------------------------------------------------------------*/
#define WINDOW_WIDTH  5
#define WINDOW_HEIGHT 5
#define WINDOW_SIZE  (WINDOW_WIDTH*WINDOW_HEIGHT)

/*----------------------------------------------------------------------------*/
/*BLK_HEIGHT: Input block height, Must be multiple of 8                       */ 
/*----------------------------------------------------------------------------*/
#define BLK_HEIGHT    8

/*----------------------------------------------------------------------------*/
/*BLK_WIDTH: Input block width, Must be multiple of 8                         */
/*Minimum block width supported is 16                                         */
/*----------------------------------------------------------------------------*/
#define BLK_WIDTH     (8*PIX_FMT)

/*----------------------------------------------------------------------------*/
/*VERT_PAD_SIZE: Vertical padding size                                        */
/*Number of lines padded at top and bottom                                    */
/*----------------------------------------------------------------------------*/
#define VERT_PAD_SIZE 2

/*----------------------------------------------------------------------------*/
/*HORZ_PAD_SIZE: Horizontal padding size                                      */
/*Number of pixels padded at left and right of input block                    */
/*----------------------------------------------------------------------------*/
#define HORZ_PAD_SIZE (2  * PIX_FMT)

/*----------------------------------------------------------------------------*/
/*BLK_STRIDE: block stride for input image                                    */
/*Number of pixel gap between the lines                                       */
/*----------------------------------------------------------------------------*/
#define INPUT_STRIDE    (12 * PIX_FMT)

/*----------------------------------------------------------------------------*/
/*QFORMAT_TBL: Qformat required for bin log division and look up map          */
/*QFORMAT_DIV:                                                                */
/*----------------------------------------------------------------------------*/
#define QFORMAT_TBL 15
#define QFORMAT_DIV 18

/*----------------------------------------------------------------------------*/
/* input_img_blk : Test example                                               */
/*----------------------------------------------------------------------------*/
#pragma DATA_ALIGN   (input_img_blk,  32)
#pragma DATA_SECTION(input_img_blk, "Adata");
unsigned char input_img_blk[12*48] = 
{  /* RGBA*/
  0x39, 0x16, 0x52, 0xFF, 0x39, 0x16, 0x52, 0xFF,0x39, 0x16, 0x52, 0xFF, 0x39, 0x16, 0x52, 0xFF, 0x3E, 0x20, 0x60, 0xFF, 0x3E, 0x1C, 0x5D, 0xFF, 0x41, 0x1E, 0x61, 0xFF, 0x39, 0x15, 0x5E, 0xFF, 0x3E, 0x1A, 0x5C, 0xFF, 0x3C, 0x1C, 0x5D, 0xFF, 0x3E, 0x1A, 0x5C, 0xFF, 0x3C, 0x1C, 0x5D, 0xFF,
  0x39, 0x16, 0x52, 0xFF, 0x39, 0x16, 0x52, 0xFF,0x39, 0x16, 0x52, 0xFF, 0x39, 0x16, 0x52, 0xFF, 0x3E, 0x20, 0x60, 0xFF, 0x3E, 0x1C, 0x5D, 0xFF, 0x41, 0x1E, 0x61, 0xFF, 0x39, 0x15, 0x5E, 0xFF, 0x3E, 0x1A, 0x5C, 0xFF, 0x3C, 0x1C, 0x5D, 0xFF, 0x3E, 0x1A, 0x5C, 0xFF, 0x3C, 0x1C, 0x5D, 0xFF,
  0x3C, 0x12, 0x54, 0xFF, 0x3C, 0x12, 0x54, 0xFF,0x3C, 0x12, 0x54, 0xFF, 0x3C, 0x12, 0x54, 0xFF, 0x3A, 0x1B, 0x5C, 0xFF, 0x3A, 0x15, 0x5D, 0xFF, 0x3E, 0x1F, 0x61, 0xFF, 0x3B, 0x15, 0x5C, 0xFF, 0x38, 0x19, 0x60, 0xFF, 0x36, 0x1B, 0x5A, 0xFF, 0x38, 0x19, 0x60, 0xFF, 0x36, 0x1B, 0x5A, 0xFF,
  0x3C, 0x17, 0x56, 0xFF, 0x3C, 0x17, 0x56, 0xFF,0x3C, 0x17, 0x56, 0xFF, 0x3C, 0x17, 0x56, 0xFF, 0x39, 0x1B, 0x5B, 0xFF, 0x42, 0x1A, 0x5B, 0xFF, 0x41, 0x1D, 0x5D, 0xFF, 0x3E, 0x17, 0x60, 0xFF, 0x3D, 0x19, 0x5F, 0xFF, 0x3C, 0x1C, 0x5E, 0xFF, 0x3D, 0x19, 0x5F, 0xFF, 0x3C, 0x1C, 0x5E, 0xFF,
  0x42, 0x1F, 0x5D, 0xFF, 0x42, 0x1F, 0x5D, 0xFF,0x42, 0x1F, 0x5D, 0xFF, 0x42, 0x1F, 0x5D, 0xFF, 0x3F, 0x19, 0x56, 0xFF, 0x39, 0x18, 0x59, 0xFF, 0x41, 0x1E, 0x5F, 0xFF, 0x3E, 0x1E, 0x60, 0xFF, 0x3D, 0x19, 0x5E, 0xFF, 0x3F, 0x1F, 0x62, 0xFF, 0x3D, 0x19, 0x5E, 0xFF, 0x3F, 0x1F, 0x62, 0xFF,
  0x39, 0x1A, 0x58, 0xFF, 0x39, 0x1A, 0x58, 0xFF,0x39, 0x1A, 0x58, 0xFF, 0x39, 0x1A, 0x58, 0xFF, 0x40, 0x23, 0x61, 0xFF, 0x3C, 0x1E, 0x5D, 0xFF, 0x40, 0x1D, 0x64, 0xFF, 0x3E, 0x1D, 0x63, 0xFF, 0x40, 0x19, 0x5E, 0xFF, 0x42, 0x22, 0x62, 0xFF, 0x40, 0x19, 0x5E, 0xFF, 0x42, 0x22, 0x62, 0xFF,
  0x38, 0x18, 0x59, 0xFF, 0x38, 0x18, 0x59, 0xFF,0x38, 0x18, 0x59, 0xFF, 0x38, 0x18, 0x59, 0xFF, 0x3F, 0x20, 0x61, 0xFF, 0x3D, 0x1D, 0x61, 0xFF, 0x39, 0x19, 0x5F, 0xFF, 0x43, 0x20, 0x5F, 0xFF, 0x3D, 0x1C, 0x61, 0xFF, 0x3D, 0x1A, 0x60, 0xFF, 0x3D, 0x1C, 0x61, 0xFF, 0x3D, 0x1A, 0x60, 0xFF,
  0x3F, 0x19, 0x59, 0xFF, 0x3F, 0x19, 0x59, 0xFF,0x3F, 0x19, 0x59, 0xFF, 0x3F, 0x19, 0x59, 0xFF, 0x3E, 0x1D, 0x60, 0xFF, 0x3B, 0x18, 0x5F, 0xFF, 0x3D, 0x1F, 0x5E, 0xFF, 0x46, 0x1F, 0x66, 0xFF, 0x3E, 0x1C, 0x5C, 0xFF, 0x40, 0x1D, 0x61, 0xFF, 0x3E, 0x1C, 0x5C, 0xFF, 0x40, 0x1D, 0x61, 0xFF,
  0x3E, 0x19, 0x5C, 0xFF, 0x3E, 0x19, 0x5C, 0xFF,0x3E, 0x19, 0x5C, 0xFF, 0x3E, 0x19, 0x5C, 0xFF, 0x3D, 0x1E, 0x63, 0xFF, 0x3B, 0x20, 0x63, 0xFF, 0x43, 0x1E, 0x67, 0xFF, 0x3C, 0x18, 0x5D, 0xFF, 0x40, 0x15, 0x5E, 0xFF, 0x42, 0x1C, 0x5F, 0xFF, 0x40, 0x15, 0x5E, 0xFF, 0x42, 0x1C, 0x5F, 0xFF,
  0x3E, 0x19, 0x58, 0xFF, 0x3E, 0x19, 0x58, 0xFF,0x3E, 0x19, 0x58, 0xFF, 0x3E, 0x19, 0x58, 0xFF, 0x42, 0x22, 0x61, 0xFF, 0x47, 0x28, 0x69, 0xFF, 0x46, 0x27, 0x65, 0xFF, 0x3F, 0x1B, 0x5F, 0xFF, 0x39, 0x1A, 0x5D, 0xFF, 0x46, 0x1F, 0x61, 0xFF, 0x39, 0x1A, 0x5D, 0xFF, 0x46, 0x1F, 0x61, 0xFF,
  0x3F, 0x18, 0x5F, 0xFF, 0x3F, 0x18, 0x5F, 0xFF,0x3F, 0x18, 0x5F, 0xFF, 0x3F, 0x18, 0x5F, 0xFF, 0x3A, 0x1D, 0x60, 0xFF, 0x47, 0x20, 0x62, 0xFF, 0x41, 0x1D, 0x62, 0xFF, 0x40, 0x1B, 0x63, 0xFF, 0x3A, 0x19, 0x60, 0xFF, 0x45, 0x1F, 0x62, 0xFF, 0x3A, 0x19, 0x60, 0xFF, 0x45, 0x1F, 0x62, 0xFF,
  0x3B, 0x1D, 0x5D, 0xFF, 0x3B, 0x1D, 0x5D, 0xFF,0x3B, 0x1D, 0x5D, 0xFF, 0x3B, 0x1D, 0x5D, 0xFF, 0x43, 0x21, 0x62, 0xFF, 0x44, 0x23, 0x66, 0xFF, 0x45, 0x22, 0x65, 0xFF, 0x44, 0x21, 0x66, 0xFF, 0x3B, 0x1C, 0x61, 0xFF, 0x49, 0x26, 0x66, 0xFF, 0x3B, 0x1C, 0x61, 0xFF, 0x49, 0x26, 0x66, 0xFF
};

/*----------------------------------------------------------------------------*/
/*LUT_RANGE_1TBL : Range Look up table                                        */
/*----------------------------------------------------------------------------*/
#pragma DATA_ALIGN   (LUT_RANGE_1TBL,  32)
#pragma DATA_SECTION(LUT_RANGE_1TBL, "Ddata");
unsigned short LUT_RANGE_1TBL[256];

/*----------------------------------------------------------------------------*/
/*LUT_SPACE_TBL : Space look up table                                         */
/*----------------------------------------------------------------------------*/
#pragma DATA_ALIGN   (LUT_SPACE_TBL,  32)
#pragma DATA_SECTION(LUT_SPACE_TBL, "Bdata");
unsigned short LUT_SPACE_TBL[25] = {0};

/*----------------------------------------------------------------------------*/
/* vcop_diff_out : intermediate difference result                             */
/*----------------------------------------------------------------------------*/
#pragma DATA_ALIGN   (vcop_diff_out,  32)
#pragma DATA_SECTION(vcop_diff_out, "Bdata"); 
unsigned char vcop_diff_out[WINDOW_SIZE * BLK_HEIGHT * BLK_WIDTH] = {0};

/*----------------------------------------------------------------------------*/
/* vcop_G_pq_out : intermediate G_pq result                                   */
/*----------------------------------------------------------------------------*/
#pragma DATA_SECTION(vcop_G_pq_out, "Adata"); 
unsigned short vcop_G_pq_out[WINDOW_SIZE*BLK_HEIGHT*BLK_WIDTH + 8] = {0};

/*----------------------------------------------------------------------------*/
/* vcop_W_p_out : intermediate W_p result                                     */
/*----------------------------------------------------------------------------*/
#pragma DATA_SECTION(vcop_W_p_out, "Bdata"); 
unsigned int vcop_W_p_out[BLK_HEIGHT * BLK_WIDTH + 8] = {0};

/*----------------------------------------------------------------------------*/
/* vcop_BF_p_out : intermediate BF_p result                                   */
/*----------------------------------------------------------------------------*/
#pragma DATA_SECTION(vcop_BF_p_out, "Bdata"); 
unsigned int vcop_BF_p_out[BLK_HEIGHT * BLK_WIDTH + 8] = {0};

/*----------------------------------------------------------------------------*/
/* vcop_filter_out : vcop output image block                                  */
/*----------------------------------------------------------------------------*/
#pragma DATA_SECTION(vcop_filter_out, "Adata");
unsigned char vcop_filter_out[BLK_HEIGHT * BLK_WIDTH] = {0};

/*----------------------------------------------------------------------------*/
/* ref_filter_out : reference output block                                    */
/*----------------------------------------------------------------------------*/
#pragma DATA_SECTION(ref_filter_out, "Ddata");  
unsigned char ref_filter_out[BLK_HEIGHT * BLK_WIDTH] = 
{
  0x3D,0x15,0x5B,0xFF,0x3D,0x15,0x57,0xFF,0x3D,0x1C,0x5F,0xFF,0x3E,0x1A,0x67,0xFF,0x3F,0x1D,0x66,0xFF,0x3D,0x18,0x67,0xFF,0x3D,0x1B,0x68,0xFF,0x39,0x1C,0x62,0xFF,
  0x3E,0x18,0x5C,0xFF,0x3E,0x19,0x5B,0xFF,0x3D,0x1C,0x61,0xFF,0x3F,0x1C,0x64,0xFF,0x3F,0x1D,0x68,0xFF,0x3E,0x1A,0x69,0xFF,0x3E,0x1C,0x68,0xFF,0x3D,0x1C,0x68,0xFF,
  0x40,0x1D,0x5D,0xFF,0x3F,0x1D,0x5D,0xFF,0x3F,0x1C,0x5A,0xFF,0x3C,0x1C,0x5D,0xFF,0x40,0x1E,0x68,0xFF,0x3F,0x1E,0x69,0xFF,0x3F,0x1D,0x69,0xFF,0x3F,0x1E,0x69,0xFF,
  0x3C,0x1C,0x62,0xFF,0x3D,0x1D,0x5E,0xFF,0x3F,0x20,0x60,0xFF,0x3E,0x1E,0x63,0xFF,0x3F,0x1E,0x62,0xFF,0x3F,0x1E,0x68,0xFF,0x3F,0x1D,0x6A,0xFF,0x40,0x1F,0x6B,0xFF,
  0x3C,0x1B,0x64,0xFF,0x3C,0x1C,0x60,0xFF,0x3E,0x1F,0x64,0xFF,0x3E,0x1E,0x6A,0xFF,0x3C,0x1D,0x6A,0xFF,0x41,0x1F,0x6A,0xFF,0x3F,0x1D,0x6A,0xFF,0x3F,0x1D,0x69,0xFF,
  0x3F,0x1B,0x65,0xFF,0x3F,0x1C,0x5F,0xFF,0x3E,0x1E,0x66,0xFF,0x3E,0x1C,0x69,0xFF,0x3E,0x1F,0x65,0xFF,0x44,0x1E,0x68,0xFF,0x3F,0x1D,0x63,0xFF,0x40,0x1D,0x6A,0xFF,
  0x3F,0x1B,0x64,0xFF,0x3F,0x1C,0x61,0xFF,0x3F,0x1E,0x64,0xFF,0x3E,0x1F,0x6A,0xFF,0x42,0x1F,0x67,0xFF,0x3F,0x1A,0x62,0xFF,0x40,0x1A,0x69,0xFF,0x41,0x1D,0x68,0xFF,
  0x3F,0x1B,0x5E,0xFF,0x3F,0x1C,0x5E,0xFF,0x41,0x20,0x66,0xFF,0x48,0x26,0x6A,0xFF,0x45,0x26,0x6B,0xFF,0x40,0x1D,0x67,0xFF,0x3D,0x1D,0x67,0xFF,0x46,0x1E,0x6A,0xFF
};

void print_output
(
unsigned char *buffer,
unsigned int blk_height,
unsigned int blk_width
);

unsigned int verify_output
(
unsigned char *output,
unsigned char *output_ref,
unsigned int blk_height,
unsigned int blk_width
);

/**
 *******************************************************************************
 * @fn       main 
 * @brief    Implementation and validation of Bilateral filter 
 * @return  - 
 *******************************************************************************
*/
int main()
{
  unsigned int status;

  /*--------------------------------------------------------------------------*/
  /*  Range look up table preparation                                         */
  /*--------------------------------------------------------------------------*/
  lut_range_preparation(LUT_RANGE_1TBL);

  /*--------------------------------------------------------------------------*/
  /*  Space look up table preparation                                         */
  /*--------------------------------------------------------------------------*/
  lut_space_preparation(LUT_SPACE_TBL);

  /*--------------------------------------------------------------------------*/
  /*  Call the natural C implementation for bilateral filter.                 */
  /*--------------------------------------------------------------------------*/
  vcop_img_bilateralFilter(input_img_blk,
                           LUT_RANGE_1TBL,
                           LUT_SPACE_TBL,
                           vcop_filter_out,
                           BLK_WIDTH,
                           BLK_HEIGHT,
                           INPUT_STRIDE,
                           HORZ_PAD_SIZE,
                           VERT_PAD_SIZE,
                           QFORMAT_TBL,
                           QFORMAT_DIV,
                           PIX_FMT,
                           vcop_W_p_out,
                           vcop_BF_p_out,
                           vcop_diff_out,
                           vcop_G_pq_out,
                           WINDOW_WIDTH,
                           WINDOW_HEIGHT
                          );

  /*--------------------------------------------------------------------------*/
  /*Compare the result with reference output                                  */
  /*--------------------------------------------------------------------------*/
  status = verify_output(vcop_filter_out,ref_filter_out,BLK_HEIGHT,BLK_WIDTH);
  if(status)
  {
    printf("PASS: bit match \n");
  }
  else
  {
    printf("FAIL: not bit match \n");
    /*------------------------------------------------------------------------*/
    /*  If there is a mismatch, print out a memory trace                      */
    /*------------------------------------------------------------------------*/
    print_output(vcop_filter_out,BLK_HEIGHT,BLK_WIDTH);
  }
  
  printf("Done!!!\n");
}

/**
 *******************************************************************************
 * @fn       verify_output 
 * @brief    function to compare output data with reference. 
 *
 * @inputs -  output    : Output data buffer from vcop
 *         -  output_ref: Reference output data buffer 
 *         -  blk_height: Block height 
 *         -  blk_width : Block width 
 * @return - None
 * @param Comments:
 *******************************************************************************
*/
unsigned int verify_output
(
unsigned char *output,
unsigned char *output_ref,
unsigned int blk_height,
unsigned int blk_width
)
{
  unsigned int i, j;
  unsigned int status = 1;

  for(i = 0; i<blk_height; ++i)
  {
    for( j = 0; j<blk_width; j++)
    {
      if((output[(i * blk_width) + j]) != (output_ref[(i * blk_width) + j]))
      {
        status = 0;
      }
    }
  }
  return(status);
}

/**
 *******************************************************************************
 * @fn       print_output 
 * @brief    Function to print the output data. 
 *
 * @inputs -  buffer    : Output data buffer from vcop
 *         -  blk_height: Block height 
 *         -  blk_width : Block width 
 * @return - None
 * @param Comments: 
 *******************************************************************************
*/
void print_output
(
unsigned char *buffer,
unsigned int   blk_height,
unsigned int   blk_width
)
{
  unsigned int i,j;

  for(i = 0; i<blk_height; ++i)
  {
    for(j = 0; j<blk_width; j++)
    {
      printf("%4x, ",buffer[(i * blk_width) + j]);
    }
    printf("\n");
  }
}


